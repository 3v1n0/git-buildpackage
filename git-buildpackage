#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# (C) 2006 Guido Guenther <agx@sigxcpu.org>
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
"""run commands to build a debian package out of a git repository"""

import sys,os,os.path,pipes
from git_buildpackage import GitTag, Command, CommandExecFailed
from git_buildpackage.git_utils import (GitRepositoryError,
                                        GitRepository, 
                                        sanitize_version)
from git_buildpackage.deb_utils import (parse_changelog,
                                        is_native,
                                        orig_file,
                                        has_orig)
from git_buildpackage.config import GBPOptionParser

output_dir = '../'

def create_orig(cp, dir, branch):
    "create an orig.tar.gz"
    output = os.path.join(dir, orig_file(cp))
    pipe = pipes.Template()
    pipe.prepend('git-archive --format=tar --prefix=%s-%s/ %s' % (cp['Source'], cp['Upstream-Version'], branch), '.-')
    pipe.append('gzip -c -9',  '--')
    try:
        ret = pipe.copy('', output)
        if ret:
            print >>sys.stderr, "Error creating %s: %d" % (output, ret)
            return False
    except OSError, err:
        print >>sys.stderr, "Error creating %s: %s" % (output, err[0])
        return False
    except:
        print >>sys.stderr, "Error creating %s" % (output,)
        return False
    return True


def main(argv):
    args = [ arg for arg in argv[1:] if arg.find('--git-') == 0 ]
    dpkg_args = [ arg for arg in argv[1:] if arg.find('--git-') == -1 ]

    if "--help" in dpkg_args:
        args.append('--help')

    parser = GBPOptionParser(command=os.path.basename(argv[0]), prefix='git-')

    parser.add_option("--git-ignore-new", action="store_true", dest="ignore_new", default=False,
                      help="build with uncommited changes in the source tree")
    parser.add_option("--git-tag", action="store_true", dest="tag", default=False,
                      help="tag after a successful build")
    parser.add_option("--git-verbose", action="store_true", dest="verbose", default=False,
                      help="verbose command execution")
    parser.add_config_file_option(option_name="builder", dest="build_cmd",
                      help="command to build the package e.g. default is '%(builder)s'")
    parser.add_config_file_option(option_name="cleaner", dest="clean_cmd",
                      help="command to build the package e.g. default is '%(cleaner)s'")
    parser.add_config_file_option(option_name="upstream-branch", dest="upstream_branch",
                      help="upstream branch, default is '%(upstream-branch)s'")
    parser.add_config_file_option(option_name="debian-branch", dest='debian_branch',
                      help="branch the debian patch is being developed on, default is '%(debian-branch)s'")
    parser.add_config_file_option(option_name="sign-tags", dest="sign_tag",
                      help="sign git tags", action="store_true")
    parser.add_config_file_option(option_name="keyid", dest="keyid",
                      help="GPG keyid to sign tags with")
    (options, args) = parser.parse_args(args)

    if options.verbose:
        Command.verbose = True

    try:
        repo=GitRepository('.')
    except GitRepositoryError:
        print >>sys.stderr,"%s is not a git repository" % (os.path.abspath('.'))
        return 1

    try:
        if not options.ignore_new:
            Command(options.clean_cmd)()
            (ret, out) = repo.is_clean()
            if not ret:
                print >>sys.stderr, "You have uncommitted changes in your source tree:"
                print >>sys.stderr, out
                print >>sys.stderr, "Use --git-ignore-new to ignore."
                return 1
        branch = repo.get_branch()
        if branch != options.debian_branch and not options.ignore_new:
            print >>sys.stderr, "You are not on branch '%s' but on '%s'" % (options.debian_branch, branch)
            print >>sys.stderr, "Use --git-ignore-new to ignore or --git-debian-branch to set the branch name."
            return 1

        cp = parse_changelog('debian/changelog')
        if not is_native(cp) and not has_orig(cp, output_dir):
            print "%s does not exist, creating from branch %s" % (orig_file(cp), options.upstream_branch)
            if not repo.has_branch(options.upstream_branch):
                print >>sys.stderr,"Upstream branch '%s' does not exist" % options.upstream
                return 1
            if not create_orig(cp, output_dir, options.upstream_branch):
                return 1

        Command(options.build_cmd, [ '-i\.git/', '-I.git' ] + dpkg_args)()
        if options.tag:
            try:
                version=cp['Version']
            except KeyError:
                print >>sys.stderr,"Can't parse version from changes file"
                return 1
            else:
                print "Tagging", version
                if not GitTag(options.sign_tag, options.keyid)(sanitize_version(version)): return 1
    except CommandExecFailed:
        return 1
    return 0

if __name__ == '__main__':
    sys.exit(main(sys.argv))

# vim:et:ts=4:sw=4:
