#!/usr/bin/make -f
  
DEB_PYTHON2_MODULE_PACKAGES = git-buildpackage
DEB_PYTHON_CLEAN_ARGS = --all

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/python-distutils.mk

EXAMPLE_SCRIPTS=\
    gbp-add-patch          \
    gbp-cowbuilder-sid     \
    gbp-posttag-push       \
    gbp-configure-unpatched-source \
    wrap_cl.py

DEB_COMPRESS_EXCLUDE=$(EXAMPLE_SCRIPTS)

PYCHECKER_ARGS=-boptparse --no-override --no-shadowbuiltin
GBP_VERSION=gbp/gbp_version.py


ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
pychecker:
	PYTHONPATH=. pychecker $(PYCHECKER_ARGS) -q gbp gbp.scripts gbp.git

checks: pychecker
	export GIT_AUTHOR_NAME="Gbp Tests";		\
	export GIT_AUTHOR_EMAIL=tests@example.com;	\
	export GIT_COMMITTER_NAME=$$GIT_AUTHOR_NAME;	\
	export GIT_COMMITTER_EMAIL=$$GIT_AUTHOR_EMAIL;	\
	python setup.py nosetests
endif

$(GBP_VERSION): debian/changelog
	echo 'gbp_version="$(DEB_VERSION)"' > $(GBP_VERSION)

build/git-buildpackage:: $(GBP_VERSION) checks
	epydoc --config=setup.cfg
	make -C docs/

binary-post-install/git-buildpackage::
	dh_bash-completion

clean::
	make -C docs/ clean
	-rm gbp/gbp_version.py

.PHONY: checks
