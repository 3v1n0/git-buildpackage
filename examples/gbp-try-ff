#!/bin/bash
#
# Try to update a package to a new upstream version

set -e

DB=$(gbp config buildpackage.debian-branch | sed 's/\(.*debian-branch=\)\(.*\)/\2/')

git checkout "${DB}"
gbp pq import --force
git checkout "${DB}"

set +e
gbp import-orig --uscan --no-interactive --no-pristine-tar
ret=$?
set -e
# no new version found
if [ $ret = 4 ]; then
    exit 0
# all other errors
elif [ $ret != 0 ]; then
    exit $ret
fi

if ! gbp pq rebase; then
    echo "Automatic rebase failed"
    git rebase --abort
    exit 1
fi

gbp pq export --commit
gbp dch -S -a
gbp buildpackage --git-pbuilder \
                 --git-ignore-new \
                 --git-no-pristine-tar \
                 --git-postbuild='lintian $GBP_CHANGES_FILE' \
                 -nc \
                 ${GBP_BUILDPACKAGE_ARGS}

NEW_VERSION=$(dpkg-parsechangelog -SVersion)
MAINTAINER=$(dpkg-parsechangelog -SMaintainer)
echo "New version ${NEW_VERSION} importet and built"

mail -s "Imported new version ${NEW_VERSION}" "${MAINTAINER}" < /dev/null

